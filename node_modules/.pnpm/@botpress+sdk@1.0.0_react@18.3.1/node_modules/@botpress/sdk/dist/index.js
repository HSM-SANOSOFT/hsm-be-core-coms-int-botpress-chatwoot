"use strict";var Ie=Object.create;var S=Object.defineProperty;var Be=Object.getOwnPropertyDescriptor;var ve=Object.getOwnPropertyNames;var be=Object.getPrototypeOf,Ce=Object.prototype.hasOwnProperty;var P=(t,e)=>{for(var n in e)S(t,n,{get:e[n],enumerable:!0})},E=(t,e,n,o)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of ve(e))!Ce.call(t,r)&&r!==n&&S(t,r,{get:()=>e[r],enumerable:!(o=Be(e,r))||o.enumerable});return t},p=(t,e,n)=>(E(t,e,"default"),n&&E(n,e,"default")),V=(t,e,n)=>(n=t!=null?Ie(be(t)):{},E(e||!t||!t.__esModule?S(n,"default",{value:t,enumerable:!0}):n,t)),xe=t=>E(S({},"__esModule",{value:!0}),t);var m={};P(m,{Bot:()=>O,BotDefinition:()=>R,BotSpecificClient:()=>I,Integration:()=>_,IntegrationDefinition:()=>w,IntegrationSpecificClient:()=>y,InterfaceDeclaration:()=>k,RuntimeError:()=>H.RuntimeError,botIdHeader:()=>B,botUserIdHeader:()=>G,configurationHeader:()=>v,configurationTypeHeader:()=>L,integrationIdHeader:()=>N,isApiError:()=>H.isApiError,messages:()=>K,operationHeader:()=>b,parseBody:()=>T,serve:()=>C,typeHeader:()=>z,webhookIdHeader:()=>j});module.exports=xe(m);var K={};P(K,{defaults:()=>Me});var i={};P(i,{default:()=>F});var W=require("@bpinternal/zui");p(i,require("@bpinternal/zui"));var F=W.z;var g=i.z.string().min(1),Q=i.z.object({text:g}),X=i.z.object({markdown:g}),Y=i.z.object({imageUrl:g}),ee=i.z.object({audioUrl:g}),te=i.z.object({videoUrl:g}),ne=i.z.object({fileUrl:g,title:g.optional()}),ie=i.z.object({latitude:i.z.number(),longitude:i.z.number(),address:i.z.string().optional(),title:i.z.string().optional()}),oe=i.z.object({title:g,subtitle:g.optional(),imageUrl:g.optional(),actions:i.z.array(i.z.object({action:i.z.enum(["postback","url","say"]),label:g,value:g}))}),J=i.z.object({text:g,options:i.z.array(i.z.object({label:g,value:g}))}),Ee=i.z.object({items:i.z.array(oe)}),Se=i.z.discriminatedUnion("type",[i.z.object({type:i.z.literal("text"),payload:Q}),i.z.object({type:i.z.literal("markdown"),payload:X}),i.z.object({type:i.z.literal("image"),payload:Y}),i.z.object({type:i.z.literal("audio"),payload:ee}),i.z.object({type:i.z.literal("video"),payload:te}),i.z.object({type:i.z.literal("file"),payload:ne}),i.z.object({type:i.z.literal("location"),payload:ie})]),Pe=i.z.object({items:i.z.array(Se)}),Me={text:{schema:Q},markdown:{schema:X},image:{schema:Y},audio:{schema:ee},video:{schema:te},file:{schema:ne},location:{schema:ie},carousel:{schema:Ee},card:{schema:oe},dropdown:{schema:J},choice:{schema:J},bloc:{schema:Pe}};var B="x-bot-id",G="x-bot-user-id",N="x-integration-id",j="x-webhook-id",L="x-bp-configuration-type",v="x-bp-configuration",b="x-bp-operation",z="x-bp-type";var se=require("node:http");var h=console;function T(t){if(!t.body)throw new Error("Missing body");return JSON.parse(t.body)}async function C(t,e=8072,n=Ae){let o=(0,se.createServer)(async(r,a)=>{try{let s=await we(r);if(s.path==="/health"){a.writeHead(200).end("ok");return}let c=await t(s);a.writeHead(c?.status??200,c?.headers??{}).end(c?.body??"{}")}catch(s){h.error("Error while handling request",{error:s?.message??"Internal error occured"}),a.writeHead(500).end(JSON.stringify({error:s?.message??"Internal error occured"}))}});return o.listen(e,()=>n(e)),o}async function we(t){let e=await Ue(t),n={};for(let r=0;r<t.rawHeaders.length;r+=2){let a=t.rawHeaders[r].toLowerCase(),s=t.rawHeaders[r+1];n[a]=s}let o=new URL(t.url??"",t.headers.host?`http://${t.headers.host}`:"http://botpress.cloud");return{body:e,path:o.pathname,query:ke(o.search,"?"),headers:n,method:t.method?.toUpperCase()??"GET"}}function ke(t,e){return t.indexOf(e)===0?t.slice(e.length):t}async function Ue(t){return new Promise((e,n)=>{if(t.method!=="POST"&&t.method!=="PUT"&&t.method!=="PATCH")return e(void 0);let o="";t.on("data",r=>o+=r.toString()),t.on("error",r=>n(r)),t.on("end",()=>e(o))})}function Ae(t){h.info(`Listening on port ${t}`)}p(m,i,module.exports);var H=require("@botpress/client");var re=require("@bpinternal/zui");var De=re.z.enum(["webhook_received","message_created","action_triggered","register","unregister","ping","create_user","create_conversation"]),ae=t=>{let e=t[B],n=t[G],o=t[N],r=t[j],a=t[L],s=t[v],c=De.parse(t[b]);if(!e)throw new Error("Missing bot headers");if(!n)throw new Error("Missing bot user headers");if(!o)throw new Error("Missing integration headers");if(!r)throw new Error("Missing webhook headers");if(!s)throw new Error("Missing configuration headers");if(!c)throw new Error("Missing operation headers");return{botId:e,botUserId:n,integrationId:o,webhookId:r,operation:c,configurationType:a??null,configuration:s?JSON.parse(Buffer.from(s,"base64").toString("utf-8")):{}}};var d={};P(d,{mapValues:()=>_e,pairs:()=>ce});var ce=t=>Object.entries(t),_e=(t,e)=>Object.fromEntries(ce(t).map(([n,o])=>[n,e(o,n)]));var M=Symbol("schemaName"),ge=t=>t?d.mapValues(t,(n,o)=>({...n,[M]:o})):{},le=t=>M in t&&t[M]!==void 0,pe=t=>t[M];var w=class{constructor(e){this.props=e;this.name=e.name,this.version=e.version,this.icon=e.icon,this.readme=e.readme,this.title=e.title,this.identifier=e.identifier,this.description=e.description,this.configuration=e.configuration,this.configurations=e.configurations,this.events=e.events,this.actions=e.actions,this.channels=e.channels,this.states=e.states,this.user=e.user,this.secrets=e.secrets,this.entities=e.entities,this.interfaces=e.interfaces}name;version;title;description;icon;readme;configuration;configurations;events;actions;channels;states;user;secrets;identifier;entities;interfaces;extend(e,n){let o=n(ge(this.entities)),r=d.pairs(o).find(([l,x])=>!le(x));if(r)throw new Error(`Cannot extend interface "${e.definition.name}" with entity "${r[0]}"; the provided schema is not part of the integration's entities.`);let a=this;a.interfaces??={};let s=d.mapValues(o,l=>({name:pe(l),schema:l.schema})),c=Object.values(s).map(l=>l.name),u=c.length===0?e.definition.name:`${e.definition.name}<${c.join(",")}>`;return a.interfaces[u]={...e,entities:s},this}};var k=class{constructor(e){this.props=e;this.name=e.name,this.version=e.version,this.entities=e.entities??{},this.templateName=e.templateName;let n=this._getEntityReference(this.entities),o=e.events===void 0?{}:d.mapValues(e.events,s=>({...s,schema:s.schema(n)})),r=e.actions===void 0?{}:d.mapValues(e.actions,s=>({...s,input:{...s.input,schema:s.input.schema(n)},output:{...s.output,schema:s.output.schema(n)}})),a=e.channels===void 0?{}:d.mapValues(e.channels,s=>({...s,messages:d.mapValues(s.messages,c=>({...c,schema:c.schema(n)}))}));this.events=o,this.actions=r,this.channels=a}name;version;entities;events;actions;channels;templateName;_getEntityReference=e=>{let n={};for(let o of Object.keys(e))n[o]=F.ref(o);return n}};var f=require("@botpress/client");var de=require("@botpress/client"),U={retries:3,retryCondition:t=>de.axiosRetry.isNetworkOrIdempotentRequestError(t)||[429,502].includes(t.response?.status??0),retryDelay:t=>t*1e3};var y=class{constructor(e){this._client=e}createConversation=e=>this._client.createConversation(e);getConversation=e=>this._client.getConversation(e);listConversations=e=>this._client.listConversations(e);getOrCreateConversation=e=>this._client.getOrCreateConversation(e);updateConversation=e=>this._client.updateConversation(e);deleteConversation=e=>this._client.deleteConversation(e);listParticipants=e=>this._client.listParticipants(e);addParticipant=e=>this._client.addParticipant(e);getParticipant=e=>this._client.getParticipant(e);removeParticipant=e=>this._client.removeParticipant(e);createEvent=e=>this._client.createEvent(e);getEvent=e=>this._client.getEvent(e);listEvents=e=>this._client.listEvents(e);createMessage=e=>this._client.createMessage(e);getOrCreateMessage=e=>this._client.getOrCreateMessage(e);getMessage=e=>this._client.getMessage(e);updateMessage=e=>this._client.updateMessage(e);listMessages=e=>this._client.listMessages(e);deleteMessage=e=>this._client.deleteMessage(e);createUser=e=>this._client.createUser(e);getUser=e=>this._client.getUser(e);listUsers=e=>this._client.listUsers(e);getOrCreateUser=e=>this._client.getOrCreateUser(e);updateUser=e=>this._client.updateUser(e);deleteUser=e=>this._client.deleteUser(e);getState=e=>this._client.getState(e);setState=e=>this._client.setState(e);getOrSetState=e=>this._client.getOrSetState(e);patchState=e=>this._client.patchState(e);configureIntegration=e=>this._client.configureIntegration(e);uploadFile=e=>this._client.uploadFile(e);upsertFile=e=>this._client.upsertFile(e);deleteFile=e=>this._client.deleteFile(e);listFiles=e=>this._client.listFiles(e);getFile=e=>this._client.getFile(e);updateFileMetadata=e=>this._client.updateFileMetadata(e)};var q=V(require("util")),A=t=>{if(process.env.BP_LOG_FORMAT==="json")return JSON.stringify({msg:q.default.format(...t),visible_to_bot_owner:!0});{let[e,...n]=t;return q.default.format(`[For Bot Owner] ${e}`,...n)}},D={forBot:()=>({info:(...t)=>{console.info(A(t))},warn:(...t)=>{console.warn(A(t))},error:(...t)=>{console.error(A(t))},debug:(...t)=>{console.debug(A(t))}})};var ue=t=>async e=>{let n=ae(e.headers),o=new f.Client({botId:n.botId,integrationId:n.integrationId,retry:U}),r=new y(o),a={ctx:n,req:e,client:r,logger:D,instance:t};try{let s;switch(n.operation){case"webhook_received":s=await Oe(a);break;case"register":s=await He(a);break;case"unregister":s=await Fe(a);break;case"message_created":s=await Ne(a);break;case"action_triggered":s=await je(a);break;case"ping":s=await Re(a);break;case"create_user":s=await Ke(a);break;case"create_conversation":s=await Ge(a);break;default:throw new Error(`Unknown operation ${n.operation}`)}return s?{...s,status:s.status??200}:{status:200}}catch(s){if((0,f.isApiError)(s)){let u=new f.RuntimeError(s.message,s);return D.forBot().error(u.message),{status:u.code,body:JSON.stringify(u.toJSON())}}console.error(s);let c=new f.RuntimeError("An unexpected error occurred in the integration. Bot owners: Check logs for more informations. Integration owners: throw a RuntimeError to return a custom error message instead.");return D.forBot().error(c.message),{status:c.code,body:JSON.stringify(c.toJSON())}}},Re=async t=>{},Oe=async({client:t,ctx:e,req:n,logger:o,instance:r})=>{let{req:a}=T(n);return r.webhook({client:t,ctx:e,req:a,logger:o})},He=async({client:t,ctx:e,req:n,logger:o,instance:r})=>{if(!r.register)return;let{webhookUrl:a}=T(n);await r.register({client:t,ctx:e,webhookUrl:a,logger:o})},Fe=async({client:t,ctx:e,req:n,logger:o,instance:r})=>{if(!r.unregister)return;let{webhookUrl:a}=T(n);await r.unregister({ctx:e,webhookUrl:a,client:t,logger:o})},Ke=async({client:t,ctx:e,req:n,logger:o,instance:r})=>{if(!r.createUser)return;let{tags:a}=T(n);return await r.createUser({ctx:e,client:t,tags:a,logger:o})},Ge=async({client:t,ctx:e,req:n,logger:o,instance:r})=>{if(!r.createConversation)return;let{channel:a,tags:s}=T(n);return await r.createConversation({ctx:e,client:t,channel:a,tags:s,logger:o})},Ne=async({ctx:t,req:e,client:n,logger:o,instance:r})=>{let{conversation:a,user:s,type:c,payload:u,message:l}=T(e),x=r.channels[a.channel];if(!x)throw new Error(`Channel ${a.channel} not found`);let $=x.messages[c];if(!$)throw new Error(`Message of type ${c} not found in channel ${a.channel}`);await $({ctx:t,conversation:a,message:l,user:s,type:c,client:n,payload:u,ack:async({tags:ye})=>{await n.updateMessage({id:l.id,tags:ye})},logger:o})},je=async({req:t,ctx:e,client:n,logger:o,instance:r})=>{let{input:a,type:s}=T(t);if(!s)throw new Error("Missing action type");let c=r.actions[s];if(!c)throw new Error(`Action ${s} not found`);let u=await c({ctx:e,input:a,client:n,type:s,logger:o});return{body:JSON.stringify({output:u})}};var _=class{constructor(e){this.props=e;this.actions=e.actions,this.channels=e.channels,this.register=e.register,this.unregister=e.unregister,this.createUser=e.createUser,this.createConversation=e.createConversation,this.webhook=e.handler}actions;channels;register;unregister;createUser;createConversation;webhook;handler=ue(this);start=e=>C(this.handler,e)};var R=class{constructor(e){this.props=e;this.integrations=e.integrations,this.user=e.user,this.conversation=e.conversation,this.message=e.message,this.states=e.states,this.configuration=e.configuration,this.events=e.events,this.recurringEvents=e.recurringEvents}integrations;user;conversation;message;states;configuration;events;recurringEvents;add(e,n){let o=this;return o.integrations||(o.integrations={}),o.integrations[e.definition.name]={enabled:n.enabled,...e,configurationType:n.configurationType,configuration:n.configuration},this}};var fe=V(require("@botpress/client"));var I=class{constructor(e){this._client=e}getConversation=e=>this._client.getConversation(e);listConversations=e=>this._client.listConversations(e);updateConversation=e=>this._client.updateConversation(e);deleteConversation=e=>this._client.deleteConversation(e);listParticipants=e=>this._client.listParticipants(e);addParticipant=e=>this._client.addParticipant(e);getParticipant=e=>this._client.getParticipant(e);removeParticipant=e=>this._client.removeParticipant(e);getEvent=e=>this._client.getEvent(e);listEvents=e=>this._client.listEvents(e);createMessage=e=>this._client.createMessage(e);getOrCreateMessage=e=>this._client.getOrCreateMessage(e);getMessage=e=>this._client.getMessage(e);updateMessage=e=>this._client.updateMessage(e);listMessages=e=>this._client.listMessages(e);deleteMessage=e=>this._client.deleteMessage(e);getUser=e=>this._client.getUser(e);listUsers=e=>this._client.listUsers(e);updateUser=e=>this._client.updateUser(e);deleteUser=e=>this._client.deleteUser(e);getState=e=>this._client.getState(e).then(n=>({state:{...n.state,payload:n.state.payload}}));setState=e=>this._client.setState(e).then(n=>({state:{...n.state,payload:n.state.payload}}));getOrSetState=e=>this._client.getOrSetState(e).then(n=>({state:{...n.state,payload:n.state.payload}}));patchState=e=>this._client.patchState(e).then(n=>({state:{...n.state,payload:n.state.payload}}));callAction=e=>this._client.callAction(e);uploadFile=e=>this._client.uploadFile(e);upsertFile=e=>this._client.upsertFile(e);deleteFile=e=>this._client.deleteFile(e);listFiles=e=>this._client.listFiles(e);getFile=e=>this._client.getFile(e);updateFileMetadata=e=>this._client.updateFileMetadata(e);searchFiles=e=>this._client.searchFiles(e);createConversation=e=>this._client.createConversation(e);getOrCreateConversation=e=>this._client.getOrCreateConversation(e);createUser=e=>this._client.createUser(e);getOrCreateUser=e=>this._client.getOrCreateUser(e)};var Te=require("@bpinternal/zui");var Le=Te.z.enum(["event_received","register","unregister","ping","action_triggered"]),me=t=>{let e=t[B],n=t[v],o=t[z],r=Le.parse(t[b]);if(!e)throw new Error("Missing bot headers");if(!o)throw new Error("Missing type headers");if(!n)throw new Error("Missing configuration headers");if(!r)throw new Error("Missing operation headers");return{botId:e,operation:r,type:o,configuration:n?JSON.parse(Buffer.from(n,"base64").toString("utf-8")):{}}};var he=t=>async e=>{let n=me(e.headers);n.operation!=="ping"&&h.info(`Received ${n.operation} operation for bot ${n.botId} of type ${n.type}`);let o=new fe.Client({botId:n.botId,retry:U}),r=new I(o),a={req:e,ctx:n,client:r,instance:t};switch(n.operation){case"action_triggered":throw new Error(`Operation ${n.operation} not supported yet`);case"event_received":await $e(a);break;case"register":await Ze(a);break;case"unregister":await qe(a);break;case"ping":await ze(a);break;default:throw new Error(`Unknown operation ${n.operation}`)}return{status:200}},ze=async t=>{},Ze=async t=>{},qe=async t=>{},$e=async({ctx:t,req:e,client:n,instance:o})=>{h.debug(`Received event ${t.type}`);let r=T(e),a=r.event;switch(t.type){case"message_created":let s={user:a.payload.user,conversation:a.payload.conversation,message:a.payload.message,states:a.payload.states,event:a};await Promise.all(o.messageHandlers.map(l=>l({client:n,ctx:t,...s})));break;case"state_expired":let c={state:a.payload.state};await Promise.all(o.stateExpiredHandlers.map(l=>l({client:n,ctx:t,...c})));break;default:let u={event:r.event};await Promise.all(o.eventHandlers.map(l=>l({client:n,ctx:t,...u})))}};var O=class{constructor(e){this.props=e}_state={messageHandlers:[],eventHandlers:[],stateExpiredHandlers:[]};message=e=>{this._state.messageHandlers.push(e)};event=e=>{this._state.eventHandlers.push(e)};stateExpired=e=>{this._state.stateExpiredHandlers.push(e)};handler=he(this._state);start=e=>C(this.handler,e)};0&&(module.exports={Bot,BotDefinition,BotSpecificClient,Integration,IntegrationDefinition,IntegrationSpecificClient,InterfaceDeclaration,RuntimeError,botIdHeader,botUserIdHeader,configurationHeader,configurationTypeHeader,integrationIdHeader,isApiError,messages,operationHeader,parseBody,serve,typeHeader,webhookIdHeader});
//# sourceMappingURL=index.js.map
